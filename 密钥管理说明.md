# 身份证证照识别系统 - 密钥管理说明

## 概述

本项目使用腾讯云OCR服务进行身份证识别,需要配置腾讯云API密钥。为了保护密钥安全,项目采用环境变量方式管理密钥,确保密钥不会被上传到代码仓库。

## 密钥配置步骤

### 1. 获取腾讯云API密钥

1. 访问腾讯云控制台: https://console.cloud.tencent.com/cam/capi
2. 登录您的腾讯云账号
3. 创建或查看您的API密钥
4. 记录 `SecretId` 和 `SecretKey`

### 2. 配置本地密钥

1. 在项目根目录找到 `local.properties.example` 文件
2. 复制该文件并重命名为 `local.properties`
3. 打开 `local.properties` 文件,填入您的真实密钥:

```properties
# Android SDK 路径(Android Studio 会自动生成)
sdk.dir=C\:\\Users\\YourUsername\\AppData\\Local\\Android\\Sdk

# 腾讯云 API 密钥配置
TENCENT_SECRET_ID=你的SecretId
TENCENT_SECRET_KEY=你的SecretKey
```

### 3. 验证配置

1. 同步 Gradle 项目(Sync Project with Gradle Files)
2. 构建项目,确保 BuildConfig 生成成功
3. 运行应用,测试身份证识别功能

## 密钥安全机制

### 工作原理

```
local.properties (本地文件,不上传)
    ↓
build.gradle.kts (读取密钥)
    ↓
BuildConfig (编译时注入)
    ↓
TencentOCRService.kt (运行时读取)
```

### 安全保障

1. **文件隔离**: `local.properties` 文件已在 `.gitignore` 中配置,不会被 Git 追踪
2. **编译时注入**: 密钥在编译时注入到 BuildConfig,不会出现在源代码中
3. **示例文件**: 提供 `local.properties.example` 作为配置模板,不包含真实密钥
4. **代码安全**: 源代码中只包含变量引用,不包含真实密钥值

### .gitignore 配置

项目的 `.gitignore` 文件已包含以下配置:

```gitignore
# 忽略本地配置文件(包含密钥)
/local.properties
local.properties
```

这确保了包含密钥的文件不会被上传到 Git 仓库。

## 技术实现

### build.gradle.kts 配置

```kotlin
defaultConfig {
    // ... 其他配置

    // 从 local.properties 读取密钥
    val properties = java.util.Properties()
    val localPropertiesFile = rootProject.file("local.properties")
    if (localPropertiesFile.exists()) {
        properties.load(localPropertiesFile.inputStream())
    }

    buildConfigField("String", "TENCENT_SECRET_ID",
        "\"${properties.getProperty("TENCENT_SECRET_ID", "")}\"")
    buildConfigField("String", "TENCENT_SECRET_KEY",
        "\"${properties.getProperty("TENCENT_SECRET_KEY", "")}\"")
}

buildFeatures {
    viewBinding = true
    buildConfig = true  // 启用 BuildConfig
}
```

### TencentOCRService.kt 使用方式

```kotlin
object TencentOCRService {
    // 从 BuildConfig 读取密钥(密钥存储在 local.properties 中)
    private val SECRET_ID = BuildConfig.TENCENT_SECRET_ID
    private val SECRET_KEY = BuildConfig.TENCENT_SECRET_KEY

    // ... 其他代码
}
```

## 团队协作

### 新成员配置流程

1. 克隆项目代码
2. 复制 `local.properties.example` 为 `local.properties`
3. 向团队管理员获取密钥
4. 填入密钥并保存
5. 同步 Gradle 并构建项目

### 注意事项

- ⚠️ **切勿**将 `local.properties` 文件提交到 Git
- ⚠️ **切勿**在代码中硬编码密钥
- ⚠️ **切勿**在聊天工具或邮件中明文传输密钥
- ✅ 使用安全的方式(如加密文件、密码管理器)共享密钥
- ✅ 定期轮换密钥,提高安全性
- ✅ 为不同环境(开发/测试/生产)使用不同的密钥

## 常见问题

### Q1: 编译时提示找不到 BuildConfig

**解决方案**:
1. 确保 `build.gradle.kts` 中启用了 `buildConfig = true`
2. 执行 Gradle Sync
3. Clean Project 后重新 Build

### Q2: 运行时提示密钥为空

**解决方案**:
1. 检查 `local.properties` 文件是否存在
2. 确认密钥配置格式正确(无多余空格)
3. 重新 Sync Gradle 并 Rebuild Project

### Q3: 如何在 CI/CD 环境中配置密钥

**解决方案**:
1. 在 CI/CD 平台配置环境变量
2. 在构建脚本中动态生成 `local.properties` 文件
3. 或使用 CI/CD 平台的密钥管理服务

示例(GitHub Actions):
```yaml
- name: Create local.properties
  run: |
    echo "TENCENT_SECRET_ID=${{ secrets.TENCENT_SECRET_ID }}" >> local.properties
    echo "TENCENT_SECRET_KEY=${{ secrets.TENCENT_SECRET_KEY }}" >> local.properties
```

## 最佳实践

1. **最小权限原则**: 为应用创建专用的子账号,仅授予 OCR 服务权限
2. **密钥轮换**: 定期更换密钥,降低泄露风险
3. **监控告警**: 在腾讯云控制台配置 API 调用监控和异常告警
4. **代码审查**: 提交代码前检查是否包含敏感信息
5. **使用密钥管理服务**: 生产环境建议使用专业的密钥管理服务(如 AWS Secrets Manager、Azure Key Vault)

## 参考资料

- [腾讯云 API 密钥管理](https://cloud.tencent.com/document/product/598/40488)
- [Android BuildConfig 使用指南](https://developer.android.com/studio/build/gradle-tips#share-custom-fields-and-resource-values-with-your-app-code)
- [Git .gitignore 配置](https://git-scm.com/docs/gitignore)
